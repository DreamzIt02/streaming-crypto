# **CI workflow** for our project structure (`workspace = streaming-crypto`, crate at `streaming-crypto/streaming-crypto`).
# **Build/test commands**: `cargo build -p crate-name` works from the workspace root.

name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # <-- allows manual runs

jobs:
  build-test:
    name: Build & Test (Rust + FFI + PyO3)
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.rust }}

      - name: Install Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          
      - name: Export PYO3_PYTHON
        shell: bash
        run: echo "PYO3_PYTHON=${{ steps.setup-python.outputs.python-path }}" >> $GITHUB_ENV

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # Ensure dev manifest blocks are in place
      - name: Ensure dev features block exists
        working-directory: streaming-crypto
        shell: bash
        run: |
          grep -q "# --- FEATURES DEV START ---" Cargo.toml || { echo "Missing FEATURES DEV START block"; exit 1; }
          grep -q "# --- FEATURES DEV END ---" Cargo.toml || { echo "Missing FEATURES DEV END block"; exit 1; }

      - name: Ensure dev dependencies block exists
        working-directory: streaming-crypto
        shell: bash
        run: |
          grep -q "# --- DEPENDENCIES DEV START ---" Cargo.toml || { echo "Missing DEPENDENCIES DEV START block"; exit 1; }
          grep -q "# --- DEPENDENCIES DEV END ---" Cargo.toml || { echo "Missing DEPENDENCIES DEV END block"; exit 1; }

      - name: Build core-api
        run: cargo build -p core-api

      - name: Test core-api
        run: cargo test -p core-api

      - name: Build ffi-api
        run: cargo build -p ffi-api

      - name: Test ffi-api
        run: cargo test -p ffi-api

      - name: Build pyo3-api
        run: cargo build -p pyo3-api

      - name: Test pyo3-api
        run: cargo test -p pyo3-api

      - name: Workspace check (core-api)
        run: cargo check --workspace --no-default-features --features core-api

      - name: Workspace check (ffi-api)
        run: cargo check --workspace --no-default-features --features ffi-api
      
      - name: Workspace check (pyo3-api)
        run: cargo check --workspace --no-default-features --features pyo3-api

      - name: Test workspace (core-api)
        run: cargo test --workspace --no-default-features --features core-api

      - name: Test workspace (ffi-api)
        run: cargo test --workspace --no-default-features --features ffi-api

      - name: Test workspace (pyo3-api)
        run: cargo test --workspace --no-default-features --features pyo3-api

      - name: Build streaming-crypto (Rust API default)
        run: cargo build -p streaming-crypto --no-default-features --features core-api

      - name: Build streaming-crypto (FFI API feature)
        run: cargo build -p streaming-crypto --no-default-features --features ffi-api

      - name: Build streaming-crypto (PyO3 API feature)
        run: cargo build -p streaming-crypto --no-default-features --features pyo3-api

      - name: Run integration tests streaming-crypto re-exports (Rust API)
        run: cargo test -p streaming-crypto --no-default-features --features core-api

      - name: Run integration tests streaming-crypto re-exports (FFI API)
        run: cargo test -p streaming-crypto --no-default-features --features ffi-api

      - name: Run integration tests streaming-crypto re-exports (PyO3 API)
        run: cargo test -p streaming-crypto --no-default-features --features pyo3-api
      
      - name: Run doctests (Rust API)
        run: cargo test -p streaming-crypto --no-default-features --features core-api --doc

      - name: Run doctests (FFI API)
        run: cargo test -p streaming-crypto --no-default-features --features ffi-api --doc

      - name: Run doctests (PyO3 API)
        run: cargo test -p streaming-crypto --no-default-features --features pyo3-api --doc

### ðŸ”‘ Key points
# - **two steps** (`Ensure dev features block` and `Ensure dev dependencies block`) that guarantee the dev blocks are present in `Cargo.toml` during CI runs.  
# - This way, CI always tests against the dev configuration with path dependencies.  
# - The publish workflow will later replace those blocks with the publish versions.